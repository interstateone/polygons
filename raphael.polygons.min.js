// ************************************************************************************************
// 
// RaphaÃ«l.js Polygon Intersection
// by Brandon Evans, 2012
// brandonevans.ca
// @interstateone
// 
// Based on Efficient Clipping of Arbitrary Polygons by Gunther Greiner and Kai Hormann
// http://davis.wpi.edu/~matt/courses/clipping/
// 
// ************************************************************************************************
function Node(a,b,c){this.x=a;this.y=b;this.intersect=c?c:!1;this.entry=!1;this.visited=!1;this.onLine=function(a,b){var c=new Node(b.x-a.x,b.y-a.y),d=new Node(this.x-a.x,this.y-a.y),e,f=c.x*c.x+c.y*c.y;if(f===0)return this.x==a.x&&this.y==a.y;e=(c.x*d.x+c.y*d.y)/f;return e>=0&&e<=1};this.toString=function(){return this.x+","+this.y}}var doesIntersect=function(a,b,c,d){var e=(d.y-c.y)*(b.x-a.x)-(d.x-c.x)*(b.y-a.y);if(e===0)return!1;var f=((d.x-c.x)*(a.y-c.y)-(d.y-c.y)*(a.x-c.x))/e,g=((b.x-a.x)*(a.y-c.y)-(b.y-a.y)*(a.x-c.x))/e,h=a.x+f*(b.x-a.x),i=a.y+f*(b.y-a.y),j=new Node(h,i,!0);return 0<=f&&f<=1&&0<=g&&g<=1?j:!1},norm=function(a,b){return Math.sqrt((b.x-a.x)*(b.x-a.x)+(b.y-a.y)*(b.y-a.y))},containmentTest=function(a,b){var c,d=new Node(0,a.y,!1),e=0;for(c=0;c<b.length;c++)doesIntersect(d,a,b[c],b[c===b.length-1?0:c+1])&&e++;return Boolean(e%2)},markEntryPoints=function(a,b,c){var d=containmentTest(a[0],b),e;c&&(d=!d);for(e=0;e<b.length;e++)if(b[e].intersect){b[e].entry=d;d=!d}};Raphael.fn.clip=function(a,b){a=a.toNodes();b=b.toNodes();var c=a.length,d=b.length,e,f,g,h,i;for(e=0;e<c;e++)if(!a[e].intersect)for(f=0;f<d;f++)if(!b[f].intersect){e+1===c?h=-e:h=1;while(a[e+h].intersect){h++;e+h===c&&(h=-e)}f+1===d?i=-f:i=1;while(b[f+i].intersect){i++;f+i===d&&(i=-f)}var j=doesIntersect(a[e],a[e+h],b[f],b[f+i]);if(j){a.splice(e+1,0,j);b.splice(f+1,0,j);c++;d++}}markEntryPoints(a,b,!0);markEntryPoints(b,a,!0);var k=a[0],l=[],m=!0,n=!0;h=0;while(k.entry!=1){h++;k=a[h]}a[h].visited=!0;do{l.push(k);if(k.intersect===!0){if(m){h=0;while(b[h].x!=k.x&&b[h].y!=k.y)h++;b[h].entry===!1?n=!0:n=!1}else{h=0;while(a[h].x!=k.x&&a[h].y!=k.y)h++;a[h].entry===!0?n=!0:n=!1}m=!m;n?h++:h--;m&&h===c?h=0:m&&h<0?h=c-1:!m&&h===d?h=0:!m&&h<0&&(h=d-1);if(m){a[h].visited=!0;k=a[h]}else{b[h].visited=!0;k=b[h]}}else{n?h++:h--;m&&h===c?h=0:m&&h<0?h=c-1:!m&&h===d?h=0:!m&&h<0&&(h=d-1);if(m){a[h].visited=!0;k=a[h]}else{b[h].visited=!0;k=b[h]}}}while(k.x!==l[0].x&&k.y!==l[0].y);return paper.path("M"+l.join("L")+"Z")};Raphael.fn.join=function(a,b){a=a.toNodes();b=b.toNodes();var c=a.length,d=b.length,e,f,g,h,i;for(e=0;e<c;e++)if(!a[e].intersect)for(f=0;f<d;f++)if(!b[f].intersect){e+1===c?h=-e:h=1;while(a[e+h].intersect){h++;e+h===c&&(h=-e)}f+1===d?i=-f:i=1;while(b[f+i].intersect){i++;f+i===d&&(i=-f)}var j=doesIntersect(a[e],a[e+h],b[f],b[f+i]);if(j){a.splice(e+1,0,j);b.splice(f+1,0,j);c++;d++}}markEntryPoints(a,b,!1);markEntryPoints(b,a,!1);var k=a[0],l=[],m=!0,n=!0;h=0;while(k.entry!=1){h++;k=a[h]}a[h].visited=!0;do{l.push(k);if(k.intersect===!0){if(m){h=0;while(b[h].x!=k.x&&b[h].y!=k.y)h++;b[h].entry===!1?n=!0:n=!1}else{h=0;while(a[h].x!=k.x&&a[h].y!=k.y)h++;a[h].entry===!0?n=!0:n=!1}m=!m;n?h++:h--;m&&h===c?h=0:m&&h<0?h=c-1:!m&&h===d?h=0:!m&&h<0&&(h=d-1);if(m){a[h].visited=!0;k=a[h]}else{b[h].visited=!0;k=b[h]}}else{n?h++:h--;m&&h===c?h=0:m&&h<0?h=c-1:!m&&h===d?h=0:!m&&h<0&&(h=d-1);if(m){a[h].visited=!0;k=a[h]}else{b[h].visited=!0;k=b[h]}}}while(k.x!==l[0].x&&k.y!==l[0].y);return paper.path("M"+l.join("L")+"Z")};Raphael.st.join=function(){var a=this.length,b,c=null;c=paper.join(this[0],this[1]);if(a>=3)for(b=2;b<a;b++)c=paper.join(c,this[b]);return c?c:!1};Raphael.el.toNodes=function(){var a=Raphael.parsePathString(this.attr("path")),b=[];a.pop();a.forEach(function(a){b.push(new Node(a[1],a[2],!1))});var c=0;for(var d=0;d<b.length;d++)c+=(b[d+1<b.length?d+1:0].x-b[d].x)*(b[d+1<b.length?d+1:0].y+b[d].y);c>0&&b.reverse();return b};